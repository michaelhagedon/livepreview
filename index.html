<html>
<head>
<title>JavaScript Markdown Editor</title>

<link rel="stylesheet" type="text/css" href="css/gollum/template.css" />
<link rel="stylesheet" type="text/css" href="css/highlightjs/github.css" />
  <style type="text/css" media="screen">
  body {
      overflow: hidden;
  }

  #editor { 
      margin: 0;
      padding: 0;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
  }

  #contentframe {
    margin: 0 auto;
    overflow: visible;
    width: 80%;
  }

  #previewframe {
      margin: 0;
      padding: 0;
      position: absolute;
      top: 0;
      bottom: 0;
      left: 10px;
      right: 0;
  }

  /* -- Start from notepag.es -- */
  #toolpanel {
    position: fixed;
    background: #666;
    top: 0;
    height: 30px;
    right: 20px;
    width: 80px;
    vertical-align: middle;
    padding: 5px 0;
    margin: 0;
    text-align: center;
  }

  #toolpanel.edit a.edit {
    opacity: 0.4;
    /* Make it appear as a link even though save
       doesn't have a href attribute. */
    cursor: pointer;
    display: inline-block;
  }

  #toolpanel a {
    color: white;
    text-decoration: none;
    margin: 0 5px;
    display: none;
    padding: 4px;
    font-family: sans-serif;
  }

  #toolpanel a img {
    vertical-align: middle;
    margin-left: 5px;
    margin: 0;
    padding: 0;
  }

  a img {
    border: none;
  }
  /* -- End from notepag.es -- */
  </style>

    <script src="js/ace/ace.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/ace/theme-twilight.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/ace/mode-markdown.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/pagedown/Markdown.Converter.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/pagedown/Markdown.Sanitizer.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/jquery/jquery-1.7.js" type="text/javascript" charset="utf-8"></script>
    <script src="js/highlightjs/highlight.pack.js" type="text/javascript" charset="utf-8"></script>
    </head>
    
    <body>
<div id="editor"># Header 1
## Header 2
### Header 3

[link](http://www.example.com)

![Image example](https://a248.e.akamai.net/assets.github.com/images/modules/about_page/octocat.png?1329920549)

**bold**

*italic*

`code`

```ruby
puts 'code highlighting'
```

- unordered list
- unordered list
- unordered list

----

0. ordered list
0. ordered list
0. ordered list

> Block Quote</div>

  <div id="previewframe"><div id="contentframe"></div></div>
   <!-- tool panel and save from notepage.es -->  
  <div id="toolpanel" class="edit" style="width: 500px; right: 0px; ">
    <a id="save" class="edit"><img src="images/save_24.png" alt="save" title="save"></a>
    <a id="toggle" class="edit" href="javascript:void(0)" onclick="jsm.toggleLeftRight();"><img src="images/lr_24.png" alt="Toggle left to right" title="Toggle left to right"></a>
  </div>
<script type="text/javascript">
(function () {
var converter = Markdown.getSanitizingConverter();
var editor = ace.edit("editor");
var editorSession = editor.getSession();
var preview = document.getElementById("previewframe");
var content = document.getElementById("contentframe");
var toolPanel = document.getElementById("toolpanel");

var leftRight = true;
var jsm = {}; // JavaScript Markdown
window.jsm = jsm;
window.jsm.toggleLeftRight = function() {
  leftRight = leftRight === false ? true : false;
  jsm.resize();
}

editor.setTheme("ace/theme/twilight");
var MarkdownMode = require("ace/mode/markdown").Mode;

editorSession.setMode(new MarkdownMode());
// Gutter shows line numbers
editor.renderer.setShowGutter(true);
editor.renderer.setHScrollBarAlwaysVisible(false);
editorSession.setUseSoftTabs(true);
editorSession.setTabSize(2);
editorSession.setUseWrapMode(true);
editor.setShowPrintMargin(false);
editor.setBehavioursEnabled(true);

window.onload = function() {
    // onChange calls applyTimeout which rate limits the calling of makePreviewHtml based on render time.
    editor.on('change', applyTimeout);
    makePreviewHtml(); // preview default text on load

    function resize() {
      var ace = editor.container;//document.getElementById("editor");
      var widthHalf = $(window).width() / 2;
      var height = $(window).height();
      ace.style.width = widthHalf + "px";
      // Minus 50 so the end of document text doesn't flow off the page.
      ace.style.height = height - 50 + "px";
      ace.style.left = leftRight === false ? widthHalf + "px" : "0px";
      ace.style.top = "40px"; // use 40px for tool menu
      ace.style.fontSize = 16 + "px";
      editor.resize();

      var previewFrame = document.getElementById("previewframe");
      previewFrame.style.width = widthHalf - 2 - 10 + "px"; // -2 for scroll bar & -10 for left offset
      previewFrame.style.height = height + "px";
      previewFrame.style.left = leftRight === false ? "10px" : widthHalf + "px";
      previewFrame.style.top = "0px";

      // Resize tool panel
      toolPanel.style.width = widthHalf + "px";
      toolPanel.style.left = leftRight === false ? widthHalf + "px" : "0px";
    }

    window.jsm.resize = resize;

    $(window).resize(function() {
      resize();
    });

    // resize for the intial page load
    resize();
};

var elapsedTime;
var oldInputText = "";

// ---- from Markdown.Editor
var previewSetter;
var timeout;

var nonSuckyBrowserPreviewSet = function (text) {
    content.innerHTML = text;
}

// IE doesn't let you use innerHTML if the element is contained somewhere in a table
// (which is the case for inline editing) -- in that case, detach the element, set the
// value, and reattach. Yes, that *is* ridiculous.
var ieSafePreviewSet = function (text) {
    var parent = content.parentNode;
    var sibling = content.nextSibling;
    parent.removeChild(content);
    content.innerHTML = text;
    if (!sibling)
        parent.appendChild(content);
    else
        parent.insertBefore(content, sibling);
}

var previewSet = function (text) {
    if (previewSetter)
        return previewSetter(text);

    try {
        nonSuckyBrowserPreviewSet(text);
        previewSetter = nonSuckyBrowserPreviewSet;
    } catch (e) {
        previewSetter = ieSafePreviewSet;
        previewSetter(text);
    }
};

var makePreviewHtml = function () {
  var text = editorSession.getValue();

  if (text && text == oldInputText) {
      return; // Input text hasn't changed.
  }
  else {
      oldInputText = text;
  }

  var prevTime = new Date().getTime();

  text = converter.makeHtml(text);

  // Calculate the processing time of the HTML creation.
  // It's used as the delay time in the event listener.
  var currTime = new Date().getTime();
  elapsedTime = currTime - prevTime;

  // Update the text using feature detection to support IE.
  // preview.innerHTML = text; // this doesn't work on IE.
  previewSet(text);

  // highlight code blocks.
  var codeElements = preview.getElementsByTagName("code");
  var codeElementsLength = codeElements.length;

  if (codeElementsLength > 0) {
    for (var idx = 0; idx < codeElementsLength; idx++) {
      var element = codeElements[idx];
      var codeHTML = element.innerHTML;
      var txt = element.innerHTML.split(/\b/);
      // the syntax for code highlighting means all code, even one line, contains newlines.
      if (txt.length > 0 && codeHTML.match(/\n/)) {
        element.className = txt[0] + " highlight";
        element.innerHTML = codeHTML.substring(txt[0].length);
        hljs.highlightBlock(element, "  ");
      } else {
        element.className = "nohighlight";
      }
    }
  }
};

// setTimeout is already used.  Used as an event listener.
var applyTimeout = function () {

    if (timeout) {
        clearTimeout(timeout);
        timeout = undefined;
    }

    // 3 second max delay
    if (elapsedTime > 3000) {
        elapsedTime = 3000;
    }
    timeout = setTimeout(makePreviewHtml, elapsedTime);
};
})();
</script>
    </body>
</html>